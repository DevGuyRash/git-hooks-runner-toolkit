{
  "id": "snapshot_1761100514474_hm23omq2h",
  "approvalId": "approval_1761100514471_rhoaytgvf",
  "approvalTitle": "Ephemeral Mode Local Tasks",
  "version": 1,
  "timestamp": "2025-10-22T02:35:14.474Z",
  "trigger": "initial",
  "status": "pending",
  "content": "- [ ] 1. Implement Ephemeral Lifecycle shell module\n  - File: lib/ephemeral_lifecycle.sh\n  - Create install, refresh, and uninstall functions that manage `.git/.githooks/` provisioning, permission setting, and cleanup traps.\n  - Ensure manifests capture previous `core.hooksPath` and precedence state.\n  - _Leverage: lib/install_common.sh, lib/config.sh, lib/logging.sh_\n  - _Requirements: Requirement 1, Requirement 2_\n  - _Prompt: Implement the task for spec ephemeral-mode-local, first run spec-workflow-guide to get the workflow guide then implement the task: Role: POSIX shell engineer experienced with Git config plumbing | Task: Build lifecycle functions in lib/ephemeral_lifecycle.sh that install, refresh, and uninstall Ephemeral Mode per Requirements 1 and 2; reuse existing install_common helpers, ensure traps restore prior state, and write manifest metadata | Restrictions: Do not modify tracked hooks directories, avoid non-POSIX syntax, keep functions idempotent | _Leverage: lib/install_common.sh, lib/config.sh, lib/logging.sh | _Requirements: Requirement 1, Requirement 2 | Success: Re-running install is idempotent, uninstall restores previous config and removes ephemeral assets, unit hooks validate manifest contents_\n\n- [ ] 2. Extend CLI dispatcher for `--mode ephemeral`\n  - File: install.sh\n  - Add argument parsing and surface CLI messages for install/uninstall with Ephemeral Mode flags (`--hooks`, `--overlay`, `--force`, `--dry-run`).\n  - Delegate to lifecycle module and print summaries including precedence info.\n  - _Leverage: lib/cli_args.sh, lib/ephemeral_lifecycle.sh_\n  - _Requirements: Requirement 1, Requirement 3_\n  - _Prompt: Implement the task for spec ephemeral-mode-local, first run spec-workflow-guide to get the workflow guide then implement the task: Role: CLI-focused shell developer | Task: Wire `install.sh` to accept `--mode ephemeral` with appropriate options, validate mutually exclusive flags, and call lifecycle helpers while emitting concise summaries covering install location and precedence | Restrictions: Preserve existing CLI behavior for other modes, avoid duplicating logic already in helper libraries, ensure help text updates remain POSIX compliant | _Leverage: lib/cli_args.sh, lib/ephemeral_lifecycle.sh | _Requirements: Requirement 1, Requirement 3 | Success: `install.sh --mode ephemeral` installs correctly, conflicting flags error out, help output lists new options_\n\n- [ ] 3. Implement overlay precedence resolver\n  - File: lib/ephemeral_overlay.sh\n  - Detect available hook roots (ephemeral `.git/.githooks/parts`, versioned `.githooks`, optional extra roots) and enforce ordering toggles.\n  - Provide helper to list active roots for logging and runner consumption.\n  - _Leverage: lib/stage.sh, lib/config.sh_\n  - _Requirements: Requirement 3_\n  - _Prompt: Implement the task for spec ephemeral-mode-local, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Shell architect specializing in configuration overlays | Task: Build overlay resolution helpers that gather hook roots, apply precedence rules (ephemeral-first default, configurable via config/env), and expose ordered arrays for the runner; log root order clearly | Restrictions: No hard-coded paths outside `.git/`, keep functions pure and testable, respect existing `.githooks/` if present | _Leverage: lib/stage.sh, lib/config.sh | _Requirements: Requirement 3 | Success: Overlay order logs match expectations, config toggles adjust precedence, runner receives correct roots_\n\n- [ ] 4. Update runner invocation to honor overlay roots\n  - File: _runner.sh\n  - Import overlay resolver, iterate through ordered roots when executing hook parts, annotate logs with root origin.\n  - Ensure behavior stays deterministic and compatible with existing stage execution.\n  - _Leverage: lib/ephemeral_overlay.sh, lib/logging.sh_\n  - _Requirements: Requirement 1, Requirement 3_\n  - _Prompt: Implement the task for spec ephemeral-mode-local, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Shell runtime maintainer | Task: Modify `_runner.sh` to query overlay roots from new helpers, iterate parts per hook with clear logging of source root, and maintain existing exit code semantics | Restrictions: Avoid regressions for non-ephemeral installs, preserve lexical ordering within each root, ensure hooks stop on non-zero when configured | _Leverage: lib/ephemeral_overlay.sh, lib/logging.sh | _Requirements: Requirement 1, Requirement 3 | Success: Runner executes overlay parts before versioned ones when configured, logs root names, existing behavior unchanged otherwise_\n\n- [ ] 5. Add automated tests for lifecycle and runner flows\n  - Files: tests/ephemeral/lifecycle.bats, tests/ephemeral/runner.bats\n  - Cover install→hook execution→reset scenarios, core.hooksPath restore, overlay precedence, and uninstall cleanup.\n  - Simulate bare/worktree and existing hooksPath cases.\n  - _Leverage: tests/helpers/git_repo.sh, tests/helpers/assertions.sh_\n  - _Requirements: Requirement 1, Requirement 2, Requirement 3_\n  - _Prompt: Implement the task for spec ephemeral-mode-local, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA engineer proficient in Bats and Git fixture setup | Task: Write integration-style Bats tests covering lifecycle idempotence, persistence across Git resets, overlay precedence, existing hooksPath restoration, and uninstall cleanup | Restrictions: Keep tests POSIX-friendly, isolate temp repos per test, ensure teardown cleans artifacts | _Leverage: tests/helpers/git_repo.sh, tests/helpers/assertions.sh | _Requirements: Requirement 1, Requirement 2, Requirement 3 | Success: Tests fail on regressions, pass across supported platforms in CI, verify cleanup and precedence behavior_\n\n- [ ] 6. Document Ephemeral Mode in CLI help and release notes\n  - Files: install.sh (help section), docs/ephemeral-mode.md, CHANGELOG.md\n  - Add help text snippets, usage examples, uninstall instructions, and migration notes.\n  - _Leverage: existing documentation style guides_\n  - _Requirements: Requirement 1, Requirement 2, Requirement 3_\n  - _Prompt: Implement the task for spec ephemeral-mode-local, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical writer with shell tooling experience | Task: Update CLI help strings and author docs covering installation steps, precedence rules, compatibility notes, and uninstall guidance | Restrictions: Preserve documentation style, avoid promises about implementation internals, ensure examples are POSIX compliant | _Leverage: existing documentation style guides | _Requirements: Requirement 1, Requirement 2, Requirement 3 | Success: Help output references Ephemeral Mode, docs include prerequisites and troubleshooting, release notes highlight feature_\n",
  "fileStats": {
    "size": 6894,
    "lines": 47,
    "lastModified": "2025-10-22T02:35:08.800Z"
  },
  "comments": []
}